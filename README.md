# é‡åŒ–åˆ†æç³»ç»Ÿ

åŸºäºæ·±åº¦å­¦ä¹ çš„é‡åŒ–åˆ†æç³»ç»Ÿï¼Œæ”¯æŒå¤šç§æ¨¡å‹æ¶æ„è¿›è¡Œæ—¶åºå›å½’é¢„æµ‹ã€‚

## ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿä¸“é—¨ç”¨äºé‡åŒ–åˆ†æï¼Œæ”¯æŒä¸¤ç§ä¸»è¦çš„æ¨¡å‹æ¶æ„ï¼š

1. **GRUæ¨¡å‹** - è½»é‡çº§æ—¶åºæ¨¡å‹ï¼Œé€‚åˆå¿«é€Ÿå®éªŒ
2. **GraphTransformeræ¨¡å‹** - é«˜çº§å›¾ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œå…·æœ‰æ›´å¼ºçš„è¡¨è¾¾èƒ½åŠ›

### ä¸»è¦ç‰¹æ€§

- ğŸš€ **å¤šæ¨¡å‹æ”¯æŒ**: æ”¯æŒGRUå’ŒGraphTransformerä¸¤ç§æ¨¡å‹æ¶æ„
- ğŸ“Š **å›å½’é¢„æµ‹**: ä¸“é—¨ç”¨äºé‡åŒ–å›å½’ä»»åŠ¡
- ğŸ¯ **å›¾ç»“æ„å»ºæ¨¡**: GraphTransformeræ¨¡å‹èƒ½å¤Ÿå»ºæ¨¡æŒ‡æ ‡é—´çš„å¤æ‚å…³ç³»
- âš¡ **é«˜æ•ˆè®­ç»ƒ**: æ”¯æŒå¤šGPUè®­ç»ƒå’Œåˆ†å¸ƒå¼è®­ç»ƒ
- ğŸ§ª **å®Œæ•´æµ‹è¯•**: æ¯ä¸ªç»„ä»¶éƒ½æœ‰ç‹¬ç«‹çš„æµ‹è¯•åŠŸèƒ½
- ğŸ“ˆ **ä¸°å¯ŒæŒ‡æ ‡**: æ”¯æŒRMSEã€RÂ²ã€Pearsonç›¸å…³ç³»æ•°ç­‰å¤šç§è¯„ä¼°æŒ‡æ ‡

## æ¨¡å‹æ¶æ„

### GRUæ¨¡å‹
- **è¾“å…¥**: `[B, 15, 12, 8]` - æ‰¹æ¬¡å¤§å° Ã— æ—¶é—´æ­¥ Ã— èŠ‚ç‚¹æ•° Ã— ç‰¹å¾ç»´åº¦
- **å¤„ç†**: å°†æ¯ä¸ªæ—¶é—´æ­¥çš„12Ã—8ç‰¹å¾å±•å¹³ä¸º96ç»´ï¼Œé€å…¥GRU
- **è¾“å‡º**: `[B, 1]` - å›å½’é¢„æµ‹å€¼
- **å‚æ•°é‡**: çº¦1-2Må‚æ•°

### GraphTransformeræ¨¡å‹
- **å›¾ç¼–ç å™¨**: ä½¿ç”¨å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶å»ºæ¨¡12ä¸ªæŒ‡æ ‡èŠ‚ç‚¹é—´çš„å…³ç³»
- **æ—¶åºæ¨¡å—**: GRUå¤„ç†å›¾è¡¨ç¤ºçš„æ—¶é—´åºåˆ—
- **å¯å­¦ä¹ è¾¹åç½®**: è‡ªåŠ¨å­¦ä¹ æŒ‡æ ‡é—´çš„ç›¸å…³æ€§
- **CLSæ±‡èš**: ä½¿ç”¨CLS tokenæ±‡èšå›¾ä¿¡æ¯
- **å‚æ•°é‡**: çº¦20-30Må‚æ•°ï¼ˆå¯é…ç½®ï¼‰

## æ–‡ä»¶ç»“æ„

```
â”œâ”€â”€ params.py              # é…ç½®æ–‡ä»¶ï¼ˆåŒ…å«æ¨¡å‹é€‰æ‹©ï¼‰
â”œâ”€â”€ dataset.py             # æ•°æ®é›†åŠ è½½å’Œå¤„ç†
â”œâ”€â”€ model.py               # æ¨¡å‹å®šä¹‰ï¼ˆGRU + GraphTransformerï¼‰
â”œâ”€â”€ learner.py             # è®­ç»ƒé€»è¾‘
â”œâ”€â”€ metrics.py             # è¯„ä¼°æŒ‡æ ‡
â”œâ”€â”€ train.py               # è®­ç»ƒå…¥å£
â”œâ”€â”€ inference.py           # æ¨ç†è„šæœ¬
â”œâ”€â”€ test_quantitative.py   # ç»¼åˆæµ‹è¯•è„šæœ¬
â”œâ”€â”€ test_graph_transformer.py  # GraphTransformerä¸“ç”¨æµ‹è¯•
â”œâ”€â”€ run_tests.py           # æµ‹è¯•è¿è¡Œå™¨
â”œâ”€â”€ train.sh               # å¤šGPUè®­ç»ƒè„šæœ¬
â”œâ”€â”€ run_single.sh          # å•GPUè®­ç»ƒè„šæœ¬
â”œâ”€â”€ infer.sh               # æ¨ç†è„šæœ¬
â”œâ”€â”€ README.md              # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ requirements.txt       # ä¾èµ–æ–‡ä»¶
â””â”€â”€ CHANGELOG.md           # å˜æ›´æ—¥å¿—
```

## é…ç½®è¯´æ˜

### æ¨¡å‹é€‰æ‹©é…ç½®

åœ¨ `params.py` ä¸­è®¾ç½®æ¨¡å‹ç±»å‹ï¼š

```python
# æ¨¡å‹é€‰æ‹©é…ç½®
params.model_type = "graph_transformer"  # "gru" æˆ– "graph_transformer"

# GRUæ¨¡å‹é…ç½®
params.gru_config = {
    "input_dim": 96,
    "hidden_dim": 256,
    "num_layers": 2,
    "dropout": 0.05,
    "fc_dims": [64],
    "use_batch_norm": False,
    "bidirectional": False,
    "pooling": "tail_mean",
    "tail_k": 8,
}

# GraphTransformeræ¨¡å‹é…ç½®
params.graph_transformer_config = {
    "graph_cfg": {
        "num_nodes": 12,
        "in_dim": 8,
        "d_model": 512,     # å›¾è¡¨ç¤ºç»´åº¦
        "n_heads": 8,
        "n_layers": 8,      # 8å±‚å›¾Transformer
        "dropout": 0.10,
        "ff_mult": 4,
        "use_node_type_embed": True,
        "prior_matrix": None,     # å¯ä¼ å…¥ç›¸å…³æ€§å…ˆéªŒ
        "prior_strength": 0.2,
    },
    "temporal_cfg": {
        "input_dim": 512,  # è‡ªåŠ¨æ¥ç®¡
        "hidden_dim": 256,
        "num_layers": 2,
        "dropout": 0.05,
        "fc_dims": [128, 64],
        "use_batch_norm": False,
        "bidirectional": False,
        "pooling": "tail_mean",
        "tail_k": 8
    }
}
```

### å¤§æ¨¡å‹é…ç½®

å¯¹äºéœ€è¦æ›´å¼ºè¡¨è¾¾èƒ½åŠ›çš„åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨å¤§æ¨¡å‹é…ç½®ï¼š

```python
params.graph_transformer_config = params.graph_transformer_large_config
```

å¤§æ¨¡å‹é…ç½®åŒ…å«ï¼š
- æ›´å¤§çš„éšè—ç»´åº¦ï¼ˆ640ï¼‰
- æ›´å¤šçš„æ³¨æ„åŠ›å¤´ï¼ˆ10ï¼‰
- æ›´å¤šçš„å±‚æ•°ï¼ˆ10å±‚ï¼‰
- çº¦30Må‚æ•°

## ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python run_tests.py

# è¿è¡Œå•ä¸ªç»„ä»¶æµ‹è¯•
python dataset.py
python model.py
python learner.py
python test_quantitative.py

# ä¸“é—¨æµ‹è¯•GraphTransformeræ¨¡å‹
python test_graph_transformer.py
```

### è®­ç»ƒæ¨¡å‹

```bash
# å•GPUè®­ç»ƒ
bash run_single.sh

# å¤šGPUè®­ç»ƒ
bash train.sh
```

### æ¨¡å‹æ¨ç†

```bash
bash infer.sh path/to/model_checkpoint.pt
```

## æ¨¡å‹åˆ‡æ¢

### ä½¿ç”¨GRUæ¨¡å‹

```python
# åœ¨params.pyä¸­è®¾ç½®
params.model_type = "gru"
```

### ä½¿ç”¨GraphTransformeræ¨¡å‹

```python
# åœ¨params.pyä¸­è®¾ç½®
params.model_type = "graph_transformer"
```

### ä½¿ç”¨å¤§æ¨¡å‹

```python
# åœ¨params.pyä¸­è®¾ç½®
params.model_type = "graph_transformer"
params.graph_transformer_config = params.graph_transformer_large_config
```

## æŠ€æœ¯ç»†èŠ‚

### GraphTransformeræ¶æ„

1. **å›¾ç¼–ç å™¨**:
   - èŠ‚ç‚¹ç‰¹å¾æŠ•å½±: `[B*T, 12, 8]` â†’ `[B*T, 12, D]`
   - èŠ‚ç‚¹ç±»å‹åµŒå…¥: ä¸ºæ¯ä¸ªæŒ‡æ ‡èŠ‚ç‚¹æ·»åŠ å¯å­¦ä¹ çš„åµŒå…¥
   - å¯å­¦ä¹ è¾¹åç½®: æ¯ä¸ªæ³¨æ„åŠ›å¤´ä¸€ä¸ª12Ã—12çš„åç½®çŸ©é˜µ
   - CLS token: ç”¨äºæ±‡èšå›¾ä¿¡æ¯
   - å¤šå±‚Transformer: 8å±‚è‡ªæ³¨æ„åŠ›æœºåˆ¶

2. **æ—¶åºæ¨¡å—**:
   - GRUå¤„ç†: `[B, 15, D]` â†’ `[B, H]`
   - æ± åŒ–ç­–ç•¥: tail_meanï¼ˆå–æœ€åkå¤©å¹³å‡ï¼‰
   - Skipè¿æ¥: åŸå§‹ç‰¹å¾çš„çº¿æ€§ç»„åˆ
   - å›å½’å¤´: å¤šå±‚æ„ŸçŸ¥æœºè¾“å‡ºé¢„æµ‹å€¼

### è®­ç»ƒç­–ç•¥

- **æŸå¤±å‡½æ•°**: SmoothL1Loss (Huber Loss)
- **ä¼˜åŒ–å™¨**: AdamW with weight decay
- **å­¦ä¹ ç‡è°ƒåº¦**: OneCycleLR
- **æ··åˆç²¾åº¦**: è‡ªåŠ¨æ··åˆç²¾åº¦è®­ç»ƒ
- **æ¢¯åº¦è£å‰ª**: é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸

### è¯„ä¼°æŒ‡æ ‡

- **RMSE**: å‡æ–¹æ ¹è¯¯å·®
- **RÂ²**: å†³å®šç³»æ•°
- **Pearson**: çš®å°”é€Šç›¸å…³ç³»æ•°
- **ç›¸å¯¹è¯¯å·®**: è‡ªå®šä¹‰å‡†ç¡®ç‡æŒ‡æ ‡

## æ€§èƒ½å¯¹æ¯”

| æ¨¡å‹ | å‚æ•°é‡ | è®­ç»ƒé€Ÿåº¦ | è¡¨è¾¾èƒ½åŠ› | é€‚ç”¨åœºæ™¯ |
|------|--------|----------|----------|----------|
| GRU | ~1-2M | å¿« | ä¸­ç­‰ | å¿«é€Ÿå®éªŒã€èµ„æºå—é™ |
| GraphTransformer | ~20-30M | ä¸­ç­‰ | å¼º | ç”Ÿäº§ç¯å¢ƒã€é«˜ç²¾åº¦éœ€æ±‚ |
| GraphTransformer-Large | ~30M+ | æ…¢ | æœ€å¼º | ç ”ç©¶ã€æœ€é«˜ç²¾åº¦éœ€æ±‚ |

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å†…å­˜ä¸è¶³**:
   - å‡å°batch_size
   - ä½¿ç”¨GRUæ¨¡å‹æ›¿ä»£GraphTransformer
   - å¯ç”¨æ¢¯åº¦ç´¯ç§¯

2. **è®­ç»ƒé€Ÿåº¦æ…¢**:
   - ä½¿ç”¨å¤šGPUè®­ç»ƒ
   - å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
   - è°ƒæ•´æ•°æ®åŠ è½½å™¨workeræ•°é‡

3. **æ¨¡å‹ä¸æ”¶æ•›**:
   - æ£€æŸ¥å­¦ä¹ ç‡è®¾ç½®
   - è°ƒæ•´dropoutç‡
   - æ£€æŸ¥æ•°æ®é¢„å¤„ç†

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨æµ‹è¯•æ¨¡å¼**:
   ```python
   params.test_mode = True
   ```

2. **æ£€æŸ¥æ¨¡å‹å‚æ•°**:
   ```python
   python model.py
   ```

3. **éªŒè¯æ•°æ®åŠ è½½**:
   ```python
   python dataset.py
   ```

## è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. æ¨é€åˆ°åˆ†æ”¯
5. åˆ›å»ºPull Request

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ã€‚

## æ›´æ–°æ—¥å¿—

è¯¦è§ [CHANGELOG.md](CHANGELOG.md)
